// ObScore MVP – single‑file React app (frontend‑only)
// Features: performer requests via email, arranger profiles, ratings, accounts (localStorage)
// NOTE: This is a prototype. No real auth, payments, or backend yet.

import { useState, useEffect } from "react";
import { Card, CardContent } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";

const EMAIL_GATEWAY = "mailto:edwardtait06@outlook.com";

function save(key, value) {
  localStorage.setItem(key, JSON.stringify(value));
}
function load(key, fallback) {
  const v = localStorage.getItem(key);
  return v ? JSON.parse(v) : fallback;
}

export default function ObScoreApp() {
  const [user, setUser] = useState(null);
  const [users, setUsers] = useState([]);
  const [requests, setRequests] = useState([]);

  useEffect(() => {
    setUsers(load("obs_users", []));
    setRequests(load("obs_requests", []));
  }, []);

  useEffect(() => {
    save("obs_users", users);
  }, [users]);

  useEffect(() => {
    save("obs_requests", requests);
  }, [requests]);

  return (
    <div className="min-h-screen bg-neutral-50 p-6 max-w-6xl mx-auto">
      <header className="mb-10">
        <h1 className="text-4xl font-bold">ObScore</h1>
        <p className="text-neutral-600">On‑demand arranging for real musicians</p>
      </header>

      {!user ? (
        <Auth users={users} setUsers={setUsers} setUser={setUser} />
      ) : (
        <Dashboard
          user={user}
          users={users}
          setUsers={setUsers}
          requests={requests}
          setRequests={setRequests}
          setUser={setUser}
        />
      )}
    </div>
  );
}

function Auth({ users, setUsers, setUser }) {
  const [email, setEmail] = useState("");
  const [role, setRole] = useState("performer");

  function submit() {
    let u = users.find((x) => x.email === email);
    if (!u) {
      u = {
        id: crypto.randomUUID(),
        email,
        role,
        bio: "",
        instruments: [],
        ratings: [],
      };
      setUsers([...users, u]);
    }
    setUser(u);
  }

  return (
    <Card className="max-w-md">
      <CardContent className="p-6 space-y-4">
        <h2 className="text-xl font-semibold">Sign up / Log in</h2>
        <Input placeholder="Email" value={email} onChange={(e) => setEmail(e.target.value)} />
        <select className="border p-2 rounded" value={role} onChange={(e) => setRole(e.target.value)}>
          <option value="performer">Performer</option>
          <option value="arranger">Arranger</option>
        </select>
        <Button onClick={submit}>Continue</Button>
      </CardContent>
    </Card>
  );
}

function Dashboard({ user, users, setUsers, requests, setRequests, setUser }) {
  return (
    <div className="space-y-10">
      <div className="flex justify-between items-center">
        <p className="text-sm text-neutral-600">Logged in as {user.email}</p>
        <Button variant="outline" onClick={() => setUser(null)}>Log out</Button>
      </div>

      {user.role === "performer" && (
        <PerformerDashboard user={user} requests={requests} setRequests={setRequests} />
      )}

      {user.role === "arranger" && (
        <ArrangerDashboard user={user} users={users} setUsers={setUsers} requests={requests} />
      )}
    </div>
  );
}

function PerformerDashboard({ user, requests, setRequests }) {
  const [description, setDescription] = useState("");

  function submitRequest() {
    const r = {
      id: crypto.randomUUID(),
      performer: user.email,
      description,
      created: new Date().toISOString(),
    };
    setRequests([...requests, r]);
    window.location.href = `${EMAIL_GATEWAY}?subject=New ObScore Request&body=${encodeURIComponent(description)}`;
  }

  return (
    <section className="space-y-4">
      <h2 className="text-2xl font-bold">Request an Arrangement</h2>
      <Textarea
        placeholder="Describe the piece, instruments, deadline, and attach files in the email step…"
        value={description}
        onChange={(e) => setDescription(e.target.value)}
      />
      <Button onClick={submitRequest}>Send Request</Button>
    </section>
  );
}

function ArrangerDashboard({ user, users, setUsers, requests }) {
  const [bio, setBio] = useState(user.bio || "");
  const [instrument, setInstrument] = useState("");

  function saveProfile() {
    const updated = users.map((u) =>
      u.email === user.email ? { ...u, bio, instruments: u.instruments } : u
    );
    setUsers(updated);
  }

  function addInstrument() {
    const updated = users.map((u) =>
      u.email === user.email
        ? { ...u, instruments: [...u.instruments, instrument] }
        : u
    );
    setUsers(updated);
    setInstrument("");
  }

  return (
    <section className="space-y-6">
      <h2 className="text-2xl font-bold">Arranger Profile</h2>
      <Textarea placeholder="Your bio" value={bio} onChange={(e) => setBio(e.target.value)} />
      <Button onClick={saveProfile}>Save Bio</Button>

      <div className="space-y-2">
        <h3 className="font-semibold">Instruments you write for</h3>
        <div className="flex gap-2">
          <Input value={instrument} onChange={(e) => setInstrument(e.target.value)} />
          <Button onClick={addInstrument}>Add</Button>
        </div>
        <ul className="list-disc pl-6">
          {user.instruments?.map((i, idx) => <li key={idx}>{i}</li>)}
        </ul>
      </div>

      <div>
        <h3 className="font-semibold">Open Requests</h3>
        <ul className="space-y-2">
          {requests.map((r) => (
            <li key={r.id} className="border p-3 rounded">
              <p className="text-sm text-neutral-600">{r.performer}</p>
              <p>{r.description}</p>
              <a
                className="text-blue-600 underline"
                href={`${EMAIL_GATEWAY}?subject=Responding to ObScore Request&body=${encodeURIComponent(r.description)}`}
              >
                Respond via Email
              </a>
            </li>
          ))}
        </ul>
      </div>
    </section>
  );
}
